%===[ What is this? ]===========================================================

% κοινός • (koinós)
%  1. shared
%  2. common
%  3. public

% This module implements and aliases some commonplace macros.


% append token list #1 to token list #2

\def\kDAppend#1#2%
{\edef\kDAct{\noexpand#2={\the#2\the#1}}\kDAct}


% gobble next token

\catcode`@=11
\let\kDGobble\pgfutil@gobble
\catcode`@=12


% gobble blank space preceeding next token

\def\kDIdentity#1{#1}


% the blank space token

\bgroup
\def\:{\global\let\kDBlankSpace= }\:
\egroup


% if next token is #1 then #2 else #3

\catcode`@=11
% ignoring whitespace
\let\kDIfNextHardCh\pgfutil@ifnextchar
\catcode`@=12

% not ignoring whitespace
\long\def\kDIfNextSoftCh#1#2#3{%
\let\kDINCToken= #1% <- MEMO: this space is crucial
\def\kDINCTrue{#2}\def\kDINCFalse{#3}%
\futurelet\kDINCTok\kDINC%
}

\def\kDINC%
  {\ifx\kDINCTok\kDINCToken\let\kDINCFalse\kDINCTrue\fi\kDINCFalse}


% tokenize stream into \kDOptTok until a group preceeding a ';' char is found,
% then put the group into \kDGrpTok and gobble the ';'.

\newtoks\kDTmpTok
\newtoks\kDOptTok
\newtoks\kDGrpTok

\def\kDFetchTilGrpThen#1#2#{%
  \kDTmpTok={#2}%
  \kDAppend\kDTmpTok\kDOptTok
  \kDFetchGrpThen{#1}}

\def\kDFetchGrpThen#1#2{%
  \def\kDExit{#1}%
  \def\kDLoop{\kDFetchTilGrpThen{#1}}%
  \kDTmpTok={{#2}}%
  \kDIfNextHardCh;
    {\kDGrpTok\the\kDTmpTok\expandafter\kDExit\kDGobble}
    {\kDAppend\kDTmpTok\kDOptTok\kDLoop}}

\let\kDFetchOptAndGrpThen\kDFetchTilGrpThen


% macros for dumping, debugging and testing

\newif\ifkDDumping
\kDDumpingfalse

\newwrite\kDDumpFile

\def\kDDumpOpen%
{\ifkDDumping\immediate\openout\kDDumpFile=\jobname.yml\fi}

\def\kDDump#1%
{\ifkDDumping\immediate\write\kDDumpFile{#1}\fi}

\def\kDDumpClose%
{\ifkDDumping\closeout\kDDumpFile\fi}


% remove trailing whitespace from token list

\newif\ifkDDTSHasTrail
\newif\ifkDDTSPrevSpace

\def\kDTrimTrailingSpace#1{
\kDDetectTrailingSpace#1
\ifkDDTSHasTrail
\def\kDRTS##1 \kD{#1={##1}}
\edef\kDRTSAct{\noexpand\kDRTS\the#1\noexpand\kD}
\kDRTSAct
\fi
}

\def\kDDetectTrailingSpace#1%
{
\kDDTSPrevSpacefalse
\edef\kDAct{\noexpand\kDDTSGob\the#1\noexpand\kD}
\kDAct
% \ifkDDTSHasTrail
% \show\kDAct
% \message{HAS TRAIL: "\the#1"}
% \showthe#1
% \fi
}

\def\kDDTSGob%
{\kDIfNextSoftCh\kD
  {\ifkDDTSPrevSpace\kDDTSHasTrailtrue\else\kDDTSHasTrailfalse\fi\kDGobble}
  {\kDIfNextSoftCh\kDBlankSpace
    {\kDDTSPrevSpacetrue\expandafter\kDDTSGob\kDIdentity}
    {\kDDTSPrevSpacefalse\expandafter\kDDTSGob\kDGobble}}}


% remove leading whitespace from token list

\def\kDGobbleSpaceThen#1%
{\kDIfNextHardCh\bgroup
  {\kDGSGroupThen#1}
  {\kDGSOtherThen#1}}

\def\kDGSGroupThen#1#2{#1{#2}}
\def\kDGSOtherThen#1#2{#1#2}

\def\kDTrimLeadingSpace#1{
\def\kDAct##1\kD{#1={##1}}
\expandafter\kDGobbleSpaceThen
\expandafter\kDAct\the#1\kD
}

