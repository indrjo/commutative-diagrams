% ================================================================= FOUNDATION =

\pgfqkeys{/kD}{
    % universal styles
    every layout/.style={
      % /ektropi/restore,% actually not needed
      /ektropi/add=/kD/layouts,
      mitra,
      nodes={/kD/every object}
    },
    every object/.style={
      /ektropi/restore,% needed inside matrices
      /ektropi/add=/kD/objects,
      self naming,
      execute at begin node=$,%
      execute at end node=$%
    },
    every arrow/.style={
      % /ektropi/restore,% actually not needed
      /ektropi/add=/kD/arrows
    },
    every label/.style={
      /ektropi/restore,% we're inside the edge
      /ektropi/add=/kD/labels,
      self naming,
      execute at begin node=$,%
      execute at end node=$,%
      auto,
      inner sep=0.5ex,
      font=\everymath\expandafter{\the\everymath\scriptstyle}
    },
    % basic arrow styles
    /kD/arrows/.cd,
      crossing over/clearance/.initial=0.5ex,
      crossing over/color/.initial=white,
      crossing over/.style={
        /tikz/preaction={
          -,
          draw=\pgfkeysvalueof{/kD/arrows/crossing over/color},
          line width=\pgfkeysvalueof{/kD/arrows/crossing over/clearance},
        },
      },
      shove/.style={
        /tikz/transform canvas={
          /tikz/shift={($(\tikztostart)!#1!-90:(\tikztotarget)-(\tikztostart)$)}
        }
      },
      slide/.style={
        /tikz/transform canvas={
          /tikz/shift={($(\tikztostart)!#1!0:(\tikztotarget)-(\tikztostart)$)}
        }
      },
    % basic label styles
    /kD/labels/.cd,
      mid/.style={
        /tikz/fill=white,
        /tikz/shape=circle,
        /tikz/anchor=center,
        /tikz/inner sep=.25ex
      },
    % basic objects styles
    /kD/objects/.cd,
    % basic lattice styles
    /kD/layouts/.cd,
      rectangular/.style 2 args={
        /tikz/column sep={#1,between origins},
        /tikz/row sep={#2,between origins}
      },
      square/.style={
        /kD/layouts/rectangular={#1}{#1}
      },
      golden/.style={
        /kD/layouts/rectangular={1.618*#1}{#1}
      },
      comb/.style={
        /kD/layouts/rectangular={sqrt(4/3)*#1}{#1},
        /tikz/every odd row/.append style={/tikz/xshift=tan(30)*#1}
      },
      comb/.default=4em,
      square/.default=4em,
      golden/.default=4em
}

% ======================================================== FIRST CHAR HANDLERS =
% a pair of shortcuts for node naming and math content

\pgfqkeys{/handlers}{
    first char syntax=true,
    first char syntax/.cd,
        the character "/.initial=\kDContentShortcut,
}

\def\kDPeelDoubleQuotes"#1"{#1}

\def\kDContentShortcut#1{%
    \pgfkeysalso{
        node contents/.expand once={\kDPeelDoubleQuotes#1},
    }%
}


% Mid level macros are bundled up into high level macros for the final user.

\tikzset{
  kodi/.code={
    \catcode`\|=12% ConTeXt fix <- TODO: insufficient? investigate

    \def\lay{\matrix[/kD/every layout]}
    \def\obj{\kDOzos[/kD/every object]}
    % TODO: maybe put mor here

  },
}





