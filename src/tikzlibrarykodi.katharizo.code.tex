% καθαρίζω • (katharízo)
%   1. clean, wash
%   2. peel, descale
%   3. (slang) kill

% Katharizo is a detokenization/sanitation mechanism.
% It produces "safe" strings from token lists.

% ,-- input          input hook
% `-> expander ---.  performs expansion according to
% ,---[expand]----'    macro expansion configuration
% `-> expanded ---.  pre-sanitation hook
% ,-- sanitizer <-'  performs detokenization and sanitation according to
% `---[replace]---.    character replacement configuration
% ,-- sanitized <-'  pre-output hook
% `-> output         output hook

%==[ input stage ]==============================================================

\pgfqkeys{/katharizo/input}{
  .forward to=/katharizo/expander,
}

%==[ expansion stage ]==========================================================

\pgfqkeys{/katharizo/expand}{.is choice,
  once/.style={/katharizo/expander/.style={/katharizo/expanded/.expand once={##1}}},
  full/.style={/katharizo/expander/.style={/katharizo/expanded/.expanded={##1}}},
  none/.style={/katharizo/expander/.style={/katharizo/expanded={##1}}},
  none, % default is no expansion
}

\pgfqkeys{/katharizo/expanded}{
  .forward to=/katharizo/sanitizer,
}

%==[ sanitation stage ]=========================================================

\pgfqkeys{/katharizo/replace}{.cd,
  space/.initial=\space,
  dollar/.initial={},
  left round brace/.initial={},
  right round brace/.initial={},
  comma/.initial={},
  full stop/.initial={},
  colon/.initial={},
  backslash/.initial={},
  underscore/.initial=_,
}

% TODO: export this somewhere else
% \newif\ifkatharizoisverbose
% \pgfqkeys{/kD}{
%   verbose/.is if=katharizoisverbose,
%   verbose=true,
%   log/.code 2 args={
%     \let~\space
%     \newlinechar=`\^
%     \message{kD.#1~>~#2^}
%   },
% }

\pgfqkeys{/katharizo/sanitizer}{.code={%
  \kDSanitize{#1}\kDInto kDFoo\kD%
  \pgfkeysalso{/katharizo/sanitized/.expanded=\kDFoo}%
  % TODO: rewrite this in a decent manner
  % logging routine:
  % \expandafter\kDDetokenize\kDKatharizoInput\kDInto kDKatharizoDetokenizedInput\kD%
  % \pgfkeysalso{/kD/log={katharizo~~~~~~~}%
  %   {{\kDKatharizoDetokenizedInput} -> (\kDFoo)}}%
}}

\pgfqkeys{/katharizo/sanitized}{
  .forward to=/katharizo/output,
}

%==[ output stage ]=============================================================

\pgfqkeys{/katharizo/output}{
}

%==[ TeX is hell <3 ]===========================================================

% This macro sanitizes tokens #1 to a string put into a macro named #2.
\def\kDSanitize#1\kDInto#2\kD{
  \kDDetokenize#1\kDInto kDKatharizoDetokenized\kD
  \edef\kDKatharizoDetokenizedTerminated{\kDKatharizoDetokenized\space}
  \expandafter\edef\csname#2\endcsname
    {\expandafter\kDSanitizeString\kDKatharizoDetokenizedTerminated\kD}
}

% This macro detokenizes tokens #1 to a string put into a macro named #2.
\def\kDDetokenize#1\kDInto#2\kD{
  \def\kDFoo{#1}
  \edef\kDBar{\meaning\kDFoo}
  \def\kDAct##1:->##2\kD{##2}
  \expandafter\edef\csname#2\endcsname{\expandafter\kDAct\kDBar\kD}
}

% These macro recursively sanitize a string, a word and a character in place.

\def\kDSanitizeString#1 #2\kD{%
  \ifx\relax#1\else\kDSanitizeWord#1\kD\fi
  \ifx\relax#1\else\if#2\space\else\ifx\relax#2\else
  \pgfkeysvalueof{/katharizo/replace/space}\fi\fi\fi
  \ifx\relax#2\else\kDSanitizeString#2\kD\fi
}

\def\kDSanitizeWord#1#2\kD{%
  \kDSanitizeCharacter#1\kD\ifx\relax#2\else\kDSanitizeWord#2\kD\fi%
}

% TODO: rethink of all the dangerous characters cross-format-wise
\def\kDSanitizeCharacter#1\kD{%
  % NOTE: spaces after number are there to avoid a stray \relax.
  \ifnum`#1=36 \pgfkeysvalueof{/katharizo/replace/dollar}\else
  \ifnum`#1=40 \pgfkeysvalueof{/katharizo/replace/left round brace}\else
  \ifnum`#1=41 \pgfkeysvalueof{/katharizo/replace/right round brace}\else
  \ifnum`#1=44 \pgfkeysvalueof{/katharizo/replace/comma}\else
  \ifnum`#1=46 \pgfkeysvalueof{/katharizo/replace/full stop}\else
  \ifnum`#1=58 \pgfkeysvalueof{/katharizo/replace/colon}\else
  \ifnum`#1=92 \pgfkeysvalueof{/katharizo/replace/backslash}\else
  \ifnum`#1=95 \pgfkeysvalueof{/katharizo/replace/underscore}\else
  #1\fi\fi\fi\fi\fi\fi\fi\fi
}
