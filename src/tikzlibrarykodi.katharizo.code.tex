%===[ What is this? ]===========================================================

% καθαρίζω • (katharízo)
%   1. clean, wash
%   2. peel, descale
%   3. (slang) kill

% The catharsis process has four stages realized by wiring TikZ keys:
%   input  --(expander)->  expanded  --(sanitizer)->  sanitized  -->  output

% \newif\ifkatharizoisverbose
\pgfqkeys{/kD}{
  % verbose/.is if=katharizoisverbose,
  % verbose=true,
  log/.code 2 args={
    \let~\space
    \newlinechar=`\^
    \message{kD.#1~>~#2^}
  },
}

%===[ TikZ magic ]==============================================================

\pgfqkeys{/katharizo/input}{
  .store in=\kDKatharizoInput,
  .forward to=/katharizo/expander,
}

\pgfqkeys{/katharizo/expand}{.is choice,
  once/.style={/katharizo/expander/.style={/katharizo/expanded/.expand once={##1}}},
  full/.style={/katharizo/expander/.style={/katharizo/expanded/.expanded={##1}}},
  none/.style={/katharizo/expander/.style={/katharizo/expanded={##1}}},
  none, % default is no expansion
}

\pgfqkeys{/katharizo/expanded}{
  .store in=\kDKatharizoExpanded,
  .forward to=/katharizo/sanitizer,
}

\pgfqkeys{/katharizo/sanitizer}{.code={%
  \kDSanitize{#1}\kDInto kDKatharizoSanitized\kD%
  \pgfkeysalso{/katharizo/sanitized/.expanded=\kDKatharizoSanitized}%
  % logging routine:
  \expandafter\kDDetokenize\kDKatharizoInput\kDInto kDKatharizoDetokenizedInput\kD%
  \pgfkeysalso{/kD/log={katharizo~~~~~~~}%
    {{\kDKatharizoDetokenizedInput} -> (\kDKatharizoSanitized)}}%
}}

\pgfqkeys{/katharizo/sanitized}{
  % .store in=\kDKatharizoSanitized,
  .forward to=/katharizo/output,
}

\pgfqkeys{/katharizo/output}{
  .store in=\kDKatharizoOutput,
}

%===[ TeX is hell <3 ]==========================================================

\def\kDDetokenize#1\kDInto#2\kD{%
  \def\kDFoo{#1}%
  \edef\kDBar{\meaning\kDFoo}%
  \def\kDAct##1:->##2\kD{##2}%
  \expandafter\edef\csname#2\endcsname{\expandafter\kDAct\kDBar\kD}%
}

\def\kDSanitize#1\kDInto#2\kD{%
  \kDDetokenize#1\kDInto kDKatharizoDetokenized\kD%
  \edef\kDKatharizoDetokenizedTerminated{\kDKatharizoDetokenized\space}%
  \expandafter\edef\csname#2\endcsname%
    {\expandafter\kDSanitizeString\kDKatharizoDetokenizedTerminated\kD}%
}

\def\kDSanitizeString#1 #2\kD%
    {%\message{"#1"+"#2"}%
\ifx\relax#1\else\kDSanitizeWord#1\kD\fi%
\ifx\relax#1\else\if#2\space\else\ifx\relax#2\else%
\pgfkeysvalueof{/katharizo/replacements/space}\fi\fi\fi%
\ifx\relax#2\else\kDSanitizeString#2\kD\fi}

\def\kDSanitizeWord#1#2\kD%
    {\kDSanitizeCharacter#1\kD\ifx\relax#2\else\kDSanitizeWord#2\kD\fi}

\pgfqkeys{/katharizo/replacements}{.cd,
  space/.initial=\space,
  dollar/.initial={},
  left round brace/.initial={},
  right round brace/.initial={},
  comma/.initial={},
  full stop/.initial={},
  colon/.initial={},
  backslash/.initial={},
  underscore/.initial=_,
}

% MEMO: Spaces after number to avoid stray \relax
% TODO: rethink of all the dangerous characters cross-format-wise
\def\kDSanitizeCharacter#1\kD{%
    \ifnum`#1=36 \pgfkeysvalueof{/katharizo/replacements/dollar}\else%
    \ifnum`#1=40 \pgfkeysvalueof{/katharizo/replacements/left round brace}\else%
    \ifnum`#1=41 \pgfkeysvalueof{/katharizo/replacements/right round brace}\else%
    \ifnum`#1=44 \pgfkeysvalueof{/katharizo/replacements/comma}\else%
    \ifnum`#1=46 \pgfkeysvalueof{/katharizo/replacements/full stop}\else%
    \ifnum`#1=58 \pgfkeysvalueof{/katharizo/replacements/colon}\else%
    \ifnum`#1=92 \pgfkeysvalueof{/katharizo/replacements/backslash}\else%
    \ifnum`#1=95 \pgfkeysvalueof{/katharizo/replacements/underscore}\else%
    #1\fi\fi\fi\fi\fi\fi\fi\fi%
}
