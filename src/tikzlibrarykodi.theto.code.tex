%===[ What is this? ]===========================================================

% θέτω • (théto)
%   1. put
%   2. set
%   3. place, position

% This module implements an alternative parsing mechanism
% for TiKz matrices of nodes.

\tikzset{
  theto/.style={
    matrix,
    cells={anchor=base},
    execute at empty cell=\kDThetoEmptyCell,
    execute at begin cell=\kDThetoBeginCell,
    execute at end cell=\kDThetoCloseCell,
  },
  %: MEMO: this *cannot* be put along with global node styles (because order of execution)
  matrix coordinates alias/.style={
    alias=\tikzmatrixname-\the\pgfmatrixcurrentrow-\the\pgfmatrixcurrentcolumn,
  },
}

\newtoks\kDThetoTokOpt
\newtoks\kDThetoTokCur
\newtoks\kDThetoTokBuf


\bgroup
\def\:{\global\let\kDBlankSpace= }\:
\egroup

\long\def\kDIfNextChar#1#2#3{%
\let\kDINCToken= #1% <- MEMO: this space is crucial
\def\kDINCTrue{#2}\def\kDINCFalse{#3}%
\futurelet\kDINCTok\kDINC%
}

\def\kDINC%
  {\ifx\kDINCTok\kDINCToken\let\kDINCFalse\kDINCTrue\fi\kDINCFalse}

\def\kDIdentity#1{#1}


\catcode`@=11


\newif\ifConTeXt

% Trick stolen from iftex. The second line is expanded inside the group so
% the global scope isn't polluted by \csname defining the token.
\begingroup\expandafter\expandafter\expandafter\endgroup\expandafter
  \ifx\csname starttext\endcsname\relax\ConTeXtfalse\else\ConTeXttrue\fi

\def\kDThetoBeginCell% TODO: is this a good place for the ConTeXt patch?
  {\ifConTeXt\catcode`|=12\fi\pgfutil@ifnextchar|{\kDThetoFetchOptions}{\kDThetoFetchOptions||}}

\def\kDThetoFetchOptions|#1|%
  {\kDThetoTokOpt={#1}\kDThetoTokBuf={}\expandafter\kDThetoMaybeGob\kDIdentity}

\newif\ifkDThetoMaybeSpace

\def\kDThetoMaybeGob%
  {\kDIfNextChar\kDBlankSpace{\kDThetoMaybeSpacetrue\eat}{\kDThetoMaybeSpacefalse\eat}}

\bgroup
\catcode`&=\active
\gdef\eat%
{\pgfutil@ifnextchar&{}%
{\pgfutil@ifnextchar\\{}%
{\ifkDThetoMaybeSpace\kDThetoAppendSpace\fi\kDThetoGob}}}
\egroup

\def\kDThetoAppendTok#1#2%
  {\edef\kDThetoAppendAct{\noexpand#2={\the#2\the#1}}\kDThetoAppendAct}

\def\kDThetoGob#1{
  \kDThetoTokCur={#1}
  \kDThetoAppendTok\kDThetoTokCur\kDThetoTokBuf
  \kDThetoMaybeGob
}

\def\kDThetoAppendSpace%
  {\kDThetoTokCur={ }\kDThetoAppendTok\kDThetoTokCur\kDThetoTokBuf}

\newif\ifkDThetoDebug
\kDThetoDebugfalse

\def\kDThetoCloseCell{
  % \edef\RESULT{"\the\kDThetoTokBuf"}\show\RESULT%
  \edef\kDThetoNode{
    \noexpand\node
      \the\kDThetoTokOpt
      [node contents={\the\kDThetoTokBuf}, matrix coordinates alias];
  }
  \kDThetoNode
  \ifkDThetoDebug\kDThetoDebugDump\fi
}

\def\kDThetoEmptyCell{
  \kDThetoTokOpt={}
  \kDThetoTokBuf={}
  \kDThetoCloseCell
}

\def\kDThetoDebugDump{
  \pgfextra{
    \bgroup\let~\space
    \immediate\write\file{'\the\pgfmatrixcurrentrow-\the\pgfmatrixcurrentcolumn':}
    \immediate\write\file{~~options: '\the\kDThetoTokOpt'}
    \immediate\write\file{~~content: '\the\kDThetoTokBuf'}
    \egroup
  }
}

\catcode`@=12
