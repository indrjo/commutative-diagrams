%===[ What is this? ]===========================================================

% θέτω • (théto)
%   1. put
%   2. set
%   3. place, position

% This module implements an alternative parsing mechanism
% for TiKz matrices of nodes.

\tikzset{
  theto/.style={
    matrix,
    cells={anchor=base},
    execute at empty cell=\kDThetoEmptyCell,
    execute at begin cell=\kDThetoBeginCell,
    execute at end cell=\kDThetoCloseCell,
    % nodes={
      % self naming,
      % execute at begin node=$,
      % execute at end node=$,
    % },
  },
  %: MEMO: this *cannot* be put along with global node styles (because order of execution)
  matrix coordinates alias/.style={
    alias=\tikzmatrixname-\the\pgfmatrixcurrentrow-\the\pgfmatrixcurrentcolumn,
  },
}

\newtoks\kDThetoTokBuf
\newtoks\kDThetoTokFub
\newtoks\kDThetoTokCur
\newtoks\kDThetoTokOpt

\catcode`@ = 11

\def\kDThetoBeginCell%
  {\pgfutil@ifnextchar|{\kDThetoFetchOptions}{\kDThetoFetchOptions||}}

\def\kDThetoFetchOptions|#1|%
  {\kDThetoTokOpt={#1}\kDThetoTokFub={}\kDThetoTokBuf={}\kDThetoMaybeBog}

\bgroup\catcode`&=\active
\gdef\kDThetoMaybeBog%
  {\pgfutil@ifnextchar&{\kDThetoFinishCell}{\pgfutil@ifnextchar\\{\kDThetoFinishCell}{\catcode`\ =13\kDThetoBog}}}
\egroup

\def\kDThetoPrependTok#1#2%
  {\edef\kDThetoPrependAct{\noexpand#2={\the#1\the#2}}\kDThetoPrependAct}

\def\kDThetoBog#1{
  \kDThetoTokCur={#1}
  \kDThetoPrependTok\kDThetoTokCur\kDThetoTokFub
  \kDThetoMaybeBog
}

\bgroup\catcode`\ =13%
\gdef\kDThetoGobSpace%
{\pgfutil@ifnextchar {\expandafter\kDThetoGobSpace\pgfutil@gobble}{\kDThetoMaybeGob}}%
\egroup

\def\kDThetoMaybeGob%
  {\pgfutil@ifnextchar\nobog{\pgfutil@gobble}{\kDThetoGob}}

\def\kDThetoGob#1{
  \kDThetoTokCur={#1}
  \kDThetoPrependTok\kDThetoTokCur\kDThetoTokBuf
  \kDThetoMaybeGob
}

\def\kDThetoFinishCell{\catcode`\ =10
  \edef\fubs{\the\kDThetoTokFub}
  \expandafter\kDThetoGobSpace\fubs\nobog
}

\def\kDThetoCloseCell{
  \edef\kDThetoNode{
    \noexpand\node
      \the\kDThetoTokOpt
      [node contents={\the\kDThetoTokBuf}, matrix coordinates alias];
  }
  \kDThetoNode
}

\def\kDThetoEmptyCell{
  \node[matrix coordinates alias]{};
}

\catcode`@ = 12
