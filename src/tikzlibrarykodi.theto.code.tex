%===[ What is this? ]===========================================================

% θέτω • (théto)
%   1. put
%   2. set
%   3. place, position

% This module implements an alternative parsing mechanism
% for TiKz matrices of nodes.

\tikzset{
  theto/.style={
    matrix,
    cells={anchor=base},
    execute at empty cell=\kDThetoEmptyCell,
    execute at begin cell=\kDThetoBeginCell,
    execute at end cell=\kDThetoCloseCell,
  },
  %: MEMO: this *cannot* be put along with global node styles (because order of execution)
  matrix coordinates alias/.style={
    alias=\tikzmatrixname-\the\pgfmatrixcurrentrow-\the\pgfmatrixcurrentcolumn,
  },
}



\newtoks\kDThetoTokOpt
\newtoks\kDThetoTokCur
\newtoks\kDThetoTokBuf

\catcode`@ = 11

\bgroup
\def\:{\global\let\kDBlankSpace= }\:
\egroup

\long\def\kDIfNextChar#1#2#3{%
\let \reserved@d = #1%
\def \reserved@a {#2}%
\def \reserved@b {#3}%
\futurelet \kDThetoINCTok \kDThetoINC%
}

\def\kDThetoINC%
  {\ifx \kDThetoINCTok \reserved@d \let \reserved@b \reserved@a \fi \reserved@b}

\def\kDThetoBeginCell%
  {\pgfutil@ifnextchar|{\kDThetoFetchOptions}{\kDThetoFetchOptions||}}

\def\kDThetoIdentity#1{#1}

\def\kDThetoFetchOptions|#1|%
  {\kDThetoTokOpt={#1}\kDThetoTokBuf={}\expandafter\kDThetoMaybeBog\kDThetoIdentity}

\newif\ifmaybespace
\maybespacefalse

\bgroup\catcode`&=\active
\gdef\kDThetoMaybeBog%
{\kDIfNextChar\kDBlankSpace{\maybespacetrue\eat}{\maybespacefalse\eat}}

\gdef\eat%
{\pgfutil@ifnextchar&{}%
{\pgfutil@ifnextchar\\{}%
{\ifmaybespace\kDThetoSpaceIt\fi\kDThetoBog}}}

\egroup

\def\kDThetoAppendTok#1#2%
  {\edef\kDThetoAppendAct{\noexpand#2={\the#2\the#1}}\kDThetoAppendAct}

\def\kDThetoBog#1{
  \kDThetoTokCur={#1}
  \kDThetoAppendTok\kDThetoTokCur\kDThetoTokBuf
  \kDThetoMaybeBog
}

\def\kDThetoSpaceIt%
  {\kDThetoTokCur={ }\kDThetoAppendTok\kDThetoTokCur\kDThetoTokBuf}

\def\kDThetoCloseCell{
  % \edef\RESULT{"\the\kDThetoTokBuf"}\show\RESULT%
  \edef\kDThetoNode{
    \noexpand\node
      \the\kDThetoTokOpt
      [node contents={\the\kDThetoTokBuf}, matrix coordinates alias];
  }
  \kDThetoNode
  \kDThetoDebugDump
}

\def\kDThetoEmptyCell{
  \kDThetoTokOpt={}
  \kDThetoTokBuf={}
  \kDThetoCloseCell
}

\def\kDThetoDebugDump{
  \pgfextra{
    \bgroup\let~\space
    \immediate\write\file{'\the\pgfmatrixcurrentrow-\the\pgfmatrixcurrentcolumn':}
    \immediate\write\file{~~options: '\the\kDThetoTokOpt'}
    \immediate\write\file{~~content: '\the\kDThetoTokBuf'}
    \egroup
  }
}

\catcode`@ = 12
