%===[ What is this? ]===========================================================

% βέλος • (vélos)
%  1. arrow
%  2. dart
%  3. shaft

% This module implements a novel parsing mechanism for arrow chains.

\usetikzlibrary{kodi.koinos}

\pgfkeys{/velos/install quote handler/.style={
    /handlers/first char syntax=true,
    /handlers/first char syntax/the character "/.initial=\kDContentShortcut,
}}

\def\kDPeelDoubleQuotes"#1"{#1}

\def\kDContentShortcut#1{%
    \pgfkeysalso{
        node contents/.expand once={\kDPeelDoubleQuotes#1},
    }%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




\newtoks\tmp



%===[ global options (labels+edges) ]===========================================

\newtoks\glab
\newtoks\gedg

\newif\ifaftercolon

\def\kDVelosFetchGlobalOptionsThen#1{
  \aftercolonfalse
  \glab={}
  \gedg={}
  \kDVelosGOMaybeFetchThen{\kDVelosGOThinkThen{#1}}
}

\def\kDVelosGOMaybeFetchThen#1{
  \tmp={}%
  \kDIfNextHardCh[{\kDVelosGOFetchThen{#1}}{#1}
}

\def\kDVelosGOFetchThen#1[#2]{\tmp={#2}#1}

\def\kDVelosGOThinkThen#1{
  \def\kDVelosGOLoop{\kDVelosGOThinkThen{#1}}
  \def\kDVelosGOBreak{#1}
  \kDIfNextHardCh:{\aftercolontrue
    \glab\expandafter{\the\tmp}
    \expandafter\kDVelosGOMaybeFetchThen\expandafter\kDVelosGOLoop\kDGobble
  }{%
    \ifaftercolon
      \gedg\expandafter{\the\tmp}
    \else
      \glab\expandafter{\the\tmp}
    \fi
    \kDVelosGOBreak
  }
}

%===[ first edge ]==============================================================

\def\kDVelosDoFirstEdgeThen#1%
{\kDVelosFetchFirstSourceThen
{\kDVelosFetchFirstEdgeThen
{\kDVelosDrawFetchedEdgeThen
{#1}}}}

\newtoks\kDVelosSource

\def\kDVelosFetchFirstSourceThen#1%
{\kDIfNextHardCh(
  {\kDVelosFFSBracketsThen{#1}}
  {\kDVelosFFSTillOverThen{#1}}}

\def\kDVelosFFSBracketsThen#1(#2){\kDVelosSource={#2}#1}
\def\kDVelosFFSTillOverThen#1#2 {\kDVelosSource={#2}#1}

\def\kDVelosFetchFirstEdgeThen#1%
{\kDVelosFetchEdgeThen
{\kDVelosFetchTargetThen
{#1}}}

%===[ chained edges ]===========================================================

\newtoks\kDVelosEdge

\def\kDVelosFetchEdgeThen#1%
{\kDVelosEdge={}\kDVelosFEThen{\kDVelosFEThinkThen{#1}}}

\def\kDVelosFEThen#1%
{\kDIfNextHardCh[
  {\kDVelosFEKeysListThen{#1}}
  {\kDIfNextHardCh"
    {\kDVelosFEEnquotedThen{#1}}
    {\kDVelosFETillOverThen{#1}}}}

\newif\iftmpiskeylist

\def\kDVelosFEEnquotedThen#1"#2"{\tmpiskeylistfalse\tmp={#2}#1}
\def\kDVelosFEKeysListThen#1[#2]{\tmpiskeylisttrue\tmp={#2}#1}
\def\kDVelosFETillOverThen#1{\tmpiskeylistfalse\tmp={}\kDVelosFETOThen{#1}}

\def\kDVelosFETOThen#1%
{\kDIfNextSoftCh\kDBlankSpace
  {#1}
  {\kDIfNextHardCh:
    {#1}
    {\kDVelosFEAppendThen{\kDVelosFETOThen{#1}}}}}

\def\kDVelosFEAppendThen#1#2{\tmp=\expandafter{\the\tmp#2}#1}

\def\kDVelosFEEdgePrepend#1%
{\edef\Act{\noexpand\kDVelosEdge={#1,\the\kDVelosEdge}}\Act}

\def\kDVelosFEThinkThen#1{%
  \def\kDVelosFELoop{\kDVelosFEThinkThen{#1}}
  \def\kDVelosFEBreak{#1}
  \kDIfNextHardCh[{
    \kDVelosFEEdgePrepend{edge node={node[every edge quotes][\the\tmp]}}
    \kDVelosFEThen\kDVelosFELoop
  }{
    \kDIfNextHardCh:{
      \iftmpiskeylist
        \kDVelosFEEdgePrepend{edge node={node[every edge quotes][\the\tmp]}}\else
        \kDVelosFEEdgePrepend{edge node={node[every edge quotes]["\the\tmp"]}}\fi
      \expandafter\kDVelosFEThen\expandafter\kDVelosFELoop\kDGobble
    }{
      \kDVelosFEEdgePrepend{\the\tmp}
      \kDVelosFEBreak
    }
  }
}

%===[ target ]==================================================================

\newtoks\kDVelosTarget

\def\kDVelosFetchTargetThen#1%
{\kDIfNextHardCh(
  {\kDVelosFTBracketsThen{#1}}
  {\kDVelosFTTillOverThen{#1}}}

\def\kDVelosFTBracketsThen#1(#2){\kDVelosTarget={#2}#1}
\def\kDVelosFTTillOverThen#1{\kDVelosTarget={}\kDVelosFTTOThen{#1}}

\def\kDVelosFTTOThen#1%
{\kDIfNextSoftCh\kDBlankSpace
  {#1}
  {\kDIfNextHardCh;
    {#1}
    {\kDVelosFTAppendThen{\kDVelosFTTOThen{#1}}}}}

\def\kDVelosFTAppendThen#1#2{\kDVelosTarget=\expandafter{\the\kDVelosTarget#2}#1}

%===[ edge rendering ]==========================================================

\def\kDVelosDrawFetchedEdgeThen#1{
% \message{^^J-------------^^J}
% \message{SOURCE: \the\kDVelosSource^^J}
% \message{ EDGE : \the\kDVelosEdge^^J}
% \message{TARGET: \the\kDVelosTarget^^J}
% \message{^^J-------------^^J}
\edef\Act{\noexpand\path[/velos/every path][
  /tikz/every edge/.append style={\the\gedg},
  /tikz/every edge quotes/.append style={\the\glab},
] (\the\kDVelosSource) edge[\the\kDVelosEdge] (\the\kDVelosTarget);}
\Act
#1}

\pgfkeys{/velos/every path/.style={
  /velos/install quote handler
}}

\def\kDVelosMaybeChainEdge%
{\kDIfNextHardCh;{}{
\kDVelosSource\expandafter{\the\kDVelosTarget}
\kDVelosFetchEdgeThen{\kDVelosFetchTargetThen
  {\kDVelosDrawFetchedEdgeThen\kDVelosMaybeChainEdge}}}}

\def\kDVelos%
{\kDVelosFetchGlobalOptionsThen{\kDVelosDoFirstEdgeThen\kDVelosMaybeChainEdge}}

\catcode`@=12
