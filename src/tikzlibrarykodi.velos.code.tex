%===[ What is this? ]===========================================================

% βέλος • (vélos)
%  1. arrow
%  2. dart
%  3. shaft

% This module implements a novel parsing mechanism for arrow chains.

\catcode`@=11

\bgroup
\def\:{\global\let\kDBlankSpace= }\:
\egroup

\long\def\kDIfNextChar#1#2#3{%
\let\kDINCToken= #1% <- MEMO: this space is crucial
\def\kDINCTrue{#2}\def\kDINCFalse{#3}%
\futurelet\kDINCTok\kDINC%
}

\def\kDINC%
  {\ifx\kDINCTok\kDINCToken\let\kDINCFalse\kDINCTrue\fi\kDINCFalse}

\let\IfNextChar\pgfutil@ifnextchar
\let\IfNextCharSoft\kDIfNextChar


\pgfkeys{/velos/install quote handler/.style={
    /handlers/first char syntax=true,
    /handlers/first char syntax/the character "/.initial=\kDContentShortcut,
}}

\def\kDPeelDoubleQuotes"#1"{#1}

\def\kDContentShortcut#1{%
    \pgfkeysalso{
        node contents/.expand once={\kDPeelDoubleQuotes#1},
    }%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newif\ifaftercolon
\aftercolonfalse

\def\catchlabelkeylist[#1]{\pgfkeys{/labels/.append style={#1}}\parser}
\def\catcharrowkeylist[#1]{\pgfkeys{/arrows/.append style={#1}}\parser}

\def\parser{%
\pgfutil@ifnextchar[{%
\ifaftercolon%
\expandafter\catcharrowkeylist\else%
\expandafter\catchlabelkeylist\fi%
}{%
\pgfutil@ifnextchar:{\aftercolontrue\expandafter\parser\pgfutil@gobble}{%
\relax% it's over
}}}





% GLOBAL OPTIONS

\newtoks\tmp



\newtoks\glab
\newtoks\gedg

\newif\ifaftercolon

\def\FetchGOptThen#1{\aftercolonfalse\glab={}\gedg={}\MaybeFetchThen{\ReflectThen{#1}}}

\def\MaybeFetchThen#1{\tmp={}\IfNextChar[{\FetchGOptListThen{#1}}{#1}}

\def\FetchGOptListThen#1[#2]{\tmp={#2}#1}

% \def\FetchAppendThen#1#2{\tmp=\expandafter{\the\tmp#2}#1}

\def\ReflectThen#1{%
  \def\Loop{\ReflectThen{#1}}
  \def\Break{#1}
  \IfNextChar:{\aftercolontrue
    \glab\expandafter{\the\tmp}
    \expandafter\MaybeFetchThen\expandafter\Loop\pgfutil@gobble
  }{%
    \ifaftercolon
      \gedg\expandafter{\the\tmp}
    \else
      \glab\expandafter{\the\tmp}
    \fi
    \Break
  }
}







%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\DoFirstEdgeThen#1%
{\FetchFirstSourceThen{\FetchFirstEdgeThen{\DrawFetchedEdgeThen{#1}}}}

% FIRST SOURCE/ARROW

\newtoks\src
\def\FetchFirstSourceThen#1%
{\IfNextChar({\FetchSourceBracketsThen{#1}}{\FetchSourceTillOverThen{#1}}}
\def\FetchSourceBracketsThen#1(#2){\src={#2}#1}
\def\FetchSourceTillOverThen#1#2 {\src={#2}#1}

\def\FetchFirstEdgeThen#1%
{\FetchEdgeThen{\FetchTargetThen{#1}}}

% EDGES

\newtoks\edg

\def\FetchEdgeThen#1{\edg={}\FetchThen{\ThinkThen{#1}}}

\def\FetchThen#1%
{\IfNextChar[{\FetchKeysListThen{#1}}%
{\IfNextChar"{\FetchEnquotedThen{#1}}{\FetchTillOverThen{#1}}}}

\newif\iftmpiskeylist

\def\FetchEnquotedThen#1"#2"{\tmpiskeylistfalse\tmp={#2}#1}
\def\FetchKeysListThen#1[#2]{\tmpiskeylisttrue\tmp={#2}#1}
\def\FetchTillOverThen#1{\tmpiskeylistfalse\tmp={}\FetchTOThen{#1}}

\def\FetchTOThen#1%
{\IfNextCharSoft\kDBlankSpace{#1}{\IfNextChar:{#1}{\FetchAppendThen{\FetchTOThen{#1}}}}}

\def\FetchAppendThen#1#2{\tmp=\expandafter{\the\tmp#2}#1}

\def\AppendTo#1#2%
{\edef\Act{\noexpand#1={\the#2\the#1}}\Act}

\def\ThinkThen#1{%
  \def\Loop{\ThinkThen{#1}}
  \def\Break{#1}
  \IfNextChar[{%
      \edef\Act{\noexpand\edg={edge node={node[every edge quotes][\the\tmp]},\the\edg}}\Act
    \FetchThen\Loop% and fetch next one
  }{%
    \IfNextChar:{
      \iftmpiskeylist
        \edef\Act{\noexpand\edg={edge node={node[every edge quotes][\the\tmp]},\the\edg}}\Act
      \else
        \edef\Act{\noexpand\edg={edge node={node[every edge quotes]["\the\tmp"]},\the\edg}}\Act
      \fi
      \expandafter\FetchThen\expandafter\Loop\pgfutil@gobble
    }{%
      \iftmpiskeylist
        \edef\Act{\noexpand\edg={\the\tmp,\the\edg}}\Act
      \else
        \edef\Act{\noexpand\edg={\the\tmp,\the\edg}}\Act
      \fi
      \Break
    }
  }
}

% TARGET

\newtoks\tar
\def\FetchTargetThen#1{\IfNextChar({\FetchTargetBracketsThen{#1}}{\FetchTargetTillOverThen{#1}}}
\def\FetchTargetBracketsThen#1(#2){\tar={#2}#1}
\def\FetchTargetTillOverThen#1{\tar={}\FetchTargetTOThen{#1}}
\def\FetchTargetTOThen#1%
{\IfNextCharSoft\kDBlankSpace{#1}{\IfNextChar;{#1}{\FetchTargetAppendThen{\FetchTargetTOThen{#1}}}}}
\def\FetchTargetAppendThen#1#2{\tar=\expandafter{\the\tar#2}#1}

\def\DrawFetchedEdgeThen#1{
% \message{^^J-------------^^J}
% \message{SOURCE: \the\src^^J}
% \message{ EDGE : \the\edg^^J}
% \message{TARGET: \the\tar^^J}
% \message{^^J-------------^^J}
\edef\Act{\noexpand\path[/velos/every path][
  /tikz/every edge/.append style={\the\gedg},
  /tikz/every edge quotes/.append style={\the\glab},
] (\the\src) edge[\the\edg] (\the\tar);}
\Act
#1}

\pgfkeys{/velos/every path/.style={
  /velos/install quote handler
}}

\def\MaybeChainAnotherEdge{
\IfNextChar;%
{}
{\src\expandafter{\the\tar}
\FetchEdgeThen{\FetchTargetThen{\DrawFetchedEdgeThen\MaybeChainAnotherEdge}}}
}

\def\kDVelos{\FetchGOptThen{\DoFirstEdgeThen\MaybeChainAnotherEdge}}

\catcode`@=12
