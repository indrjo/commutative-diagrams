\documentclass[12pt]{scrbook}
\usepackage[british]{babel}

% \hyphenation{Fortran hy-phen-ation}

\usepackage{libertine}
\usepackage{libertinust1math}
\usepackage[ttdefault=true]{AnonymousPro}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

% \def\id{{\mathbf 1}}
% \DeclareUnicodeCharacter{0131}{{\noexpand\mathbf R}}
% \DeclareUnicodeCharacter{00D7}{{\otimes}}
% \catcode`ı=\active \letı\id
% \catcode`×=\active \let×\otimes
% \usepackage{newunicodechar}
% \newunicodechar{ı}{\mathbf 1}
% \newunicodechar{×}{\otimes}

\setkomafont{disposition}{\rmfamily\scshape}

\usepackage{geometry}

\geometry{
  a4paper,
  portrait,
  marginparwidth=4.25cm,
  marginparsep=.75cm,
  % showframe,
  width=11cm,
  hmarginratio=10:25,
  vmarginratio=20:30,
%  footskip=.5in,
}
%\savegeometry{main}

%\usepackage{multicol}
%\usepackage{tabularx}
%\usepackage{verbatimbox}
% \usepackage{wrapfig}

\usepackage{parskip}

\usepackage{mathtools}
\usepackage{amsfonts}
\usepackage{amssymb}


\DeclareMathOperator{\coker}{coker}

\usepackage{float}
% \usepackage{framed}
% \usepackage{lipsum}
% \usepackage{enumitem}
% \usepackage{pdfpages}

% \usepackage{caption}
\usepackage{sidenotes}

% \DeclareCaptionStyle{sidecaption}%
% {font=footnotesize,labelfont=sc}

% \usepackage{csquotes}

\usepackage{graphicx}
% \usepackage[makeroom]{cancel}

\usepackage{etoolbox}

% \usepackage{todonotes}
% \usepackage{marginnote}

% \usepackage[lastpage,user]{zref}
% \usepackage[hidelinks]{hyperref}

\usepackage{xcolor}
\usepackage{tikz}
% \usetikzlibrary{cd}
% \usetikzlibrary{quotes}
% \pgfkeys{/handlers/first char syntax=false}

\usetikzlibrary{kodi}
\usetikzlibrary{positioning}

% \usepackage[all]{xy}
% \usepackage{pstricks,pst-node}


\usepackage{xparse}

\usepackage[
  headwidth=textwithmarginpar,
  footwidth=textwithmarginpar,
]{scrlayer-scrpage}
%\clearpairofpagestyles

% \lofoot{}
% \cofoot{}
% \rofoot{}
% \lohead{}
% \cohead{}
% \rohead{\thepage}

%\usepackage{multicol}

\usepackage{microtype}

\usepackage{listings}

% http://tex.stackexchange.com/a/336331/82186
\makeatletter
\lst@Key{lastline}\relax{\ifnumcomp{#1}{<}{0}{%
  \let\mylst@file\lst@intname\sbox0{\lstinputlisting{\mylst@file}}%
  \def\lst@lastline{\the\numexpr#1+\value{lstnumber}-1\relax}}%
  {\def\lst@lastline{#1\relax}}}
\makeatother



\usepackage{showexpl}
\makeatletter
\lst@Key{postset}\relax{\def\SX@postset{#1}}
\newcommand\SX@postset{}
\renewcommand*\SX@resultInput{%
  \ifx\SX@graphicname\@empty
    \begingroup
      \MakePercentComment\makeatother\catcode`\^^M=5\relax
      \SX@@preset\SX@preset
      \if@SX@rangeaccept
       \let\SX@tempa=\SX@input
      \else
       \let\SX@tempa=\input
      \fi
      \if\SX@scaled ?%
        \let\SX@tempb=\@firstofone
      \else
        \if\SX@scaled !%
          \def\SX@tempb##1{\resizebox{\SX@width}{!}{##1}}%
        \else
          \def\SX@tempb##1{\scalebox{\SX@scaled}{##1}}%
        \fi
      \fi
      \SX@tempb{\SX@tempa{\SX@codefile}}\SX@postset\par
    \endgroup
  \else
    \expandafter\includegraphics\expandafter[\SX@graphicparam]%
      {\SX@graphicname}%
  \fi
}
\makeatother

\lstdefinelanguage{TikZ}
{morekeywords={for},
sensitive=false,
morecomment=[l]{//},
morecomment=[s]{/*}{*/},
morestring=[b]",
}

\usepackage{color,soul}
\definecolor{darkblue}{rgb}{0,0,0.5}
\setulcolor{darkblue}

\lstset{
  language=[LaTeX]TeX,
  basicstyle=\ttfamily\lst@ifdisplaystyle\scriptsize\fi,
  backgroundcolor=\color{teal!5},
  % keywordstyle=*\color{blue},
  % identifierstyle=\color{orange}\bfseries,
  % morekeywords={\path},
  moretexcs={
    \starttext,\stoptext,\usemodule,
    \tikzpicture,\endtikzpicture,
    \tikzexternalize,
    \starttikzpicture,\stoptikzpicture,
    \usetikzlibrary,
    \kodi,\endkodi,
    \startkodi,\stopkodi,
    \lay,\obj,\mor,
    \bye
  },
  texcsstyle=*\textbf,
  % morestring=[b]",
  commentstyle=\itshape,
  frame=none,
  % extendedchars=false,
  % inputencoding=utf8,
  escapeinside={(@}{@)},
  moredelim=**[is][\color{orange!80!black}]{@opt@}{@/opt@},
  moredelim=**[s][\itshape]{<}{>},
  literate={:=}{{$\equiv$}}1 {~}{{\textvisiblespace}}1,
}

% \makeatletter
% \newcount\ublvl\ublvl=0
% \newcount\ubdpt\ubdpt=0
% \newdimen\ubgap\ubgap=.2em
% \def\underbra#1{\underline {\sbox \tw@ {\global\advance\ubdpt1\advance\ublvl1#1}\dp \tw@ \dimexpr\ubgap*(\ubdpt-\ublvl-1)\relax \box \tw@ }\ifnum\ublvl=0\ubdpt=0\fi}
% \makeatother

\lstset{explpreset={
  wide,
  basicstyle=\ttfamily\scriptsize,
  pos=o,
  width=\marginparwidth,
  hsep=\marginparsep,
  rframe={},
  preset={\centering\tikzpicture[kodi]},
  postset={\endtikzpicture}
}}

\usepackage{lipsum}
\usepackage{caption}
\usepackage{subcaption}

\captionsetup[marginfigure]{
  textfont=bf,
  justification=centering
}
\captionsetup[subfigure]{
  textfont=normalfont,
  singlelinecheck=off,
  justification=centering
}

\usepackage{hologo}
\def\ConTeXt{\hologo{ConTeXt}}
\def\koDi{{\scshape koDi}}
\def\TikZ{{\scshape TikZ}}

\usepackage{tcolorbox}
\tcbuselibrary{listingsutf8}
\tcbset{listing utf8=latin1}

\tcbset{kodi snippet/.style={
  size=tight,
  colback=white,
  colframe=white,
  if odd page={
    listing side text,
    lefthand width=\textwidth,
    righthand width=\marginparwidth,
    halign lower=center,
  }{
    text side listing,
    righthand width=\textwidth,
    lefthand width=\marginparwidth,
    halign upper=center,
  },
  toggle enlargement,
  grow to right by=\marginparsep+\marginparwidth,
  sidebyside gap=\marginparsep,
  listing options={
    firstline=2,
    lastline=-1
  }
}}

\tcbset{xy snippet/.style={
  size=tight,
  colback=white,
  colframe=white,
  if odd page={
    listing side text,
    lefthand width=\textwidth,
    righthand width=\marginparwidth,
    halign lower=center,
  }{
    text side listing,
    righthand width=\textwidth,
    lefthand width=\marginparwidth,
    halign upper=center,
  },
  toggle enlargement,
  grow to right by=\marginparsep+\marginparwidth,
  sidebyside gap=\marginparsep,
}}



\def\nilstrut{\rule{0sp}{0sp}}
